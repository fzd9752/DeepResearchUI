# Yunque DeepResearch Agent 框架深度分析

## 一、架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    USER QUESTION                                     │
│                           "你知道机智流是什么吗？"                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   MAIN AGENT                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │ Reasoning│  │ Planning │  │ Synthesis│  │Reflection│  │  Assign  │  │  Report  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
           │                           │                              │
           ▼                           ▼                              ▼
┌────────────────────┐   ┌────────────────────────────┐   ┌────────────────────┐
│  CONTEXT MANAGER   │   │   ATOMIC CAPABILITY POOL   │   │    SUPERVISOR      │
│                    │   │                            │   │                    │
│ ┌────────────────┐ │   │  ┌──────────────────────┐  │   │ ┌────────────────┐ │
│ │ Folded Memory  │ │   │  │  Browser-Use Agent   │  │   │ │Anomaly Detect  │ │
│ │ ├─ Unit 1      │ │   │  │  (动态浏览/视觉定位)  │  │   │ └────────────────┘ │
│ │ │  Sub-goal A  │ │   │  └──────────────────────┘  │   │         │          │
│ │ │  Summary     │ │   │  ┌──────────────────────┐  │   │         ▼          │
│ │ │  Tools Log   │ │   │  │ Data Analysis Agent  │  │   │ ┌────────────────┐ │
│ │ └─ Unit 2...   │ │   │  │  (数据分析/代码生成)  │  │   │ │    Pruning     │ │
│ └────────────────┘ │   │  └──────────────────────┘  │   │ └────────────────┘ │
│                    │   │  ┌──────────────────────┐  │   │         │          │
│ ┌────────────────┐ │   │  │    Basic Tools       │  │   │         ▼          │
│ │Fine-grained    │ │   │  │  • Search (Serper)   │  │   │ ┌────────────────┐ │
│ │Traces          │ │   │  │  • Visit (Jina+MCP)  │  │   │ │ Re-generation  │ │
│ │ ┌────────────┐ │ │   │  │  • Code (Sandbox)    │  │   │ └────────────────┘ │
│ │ │Think→Act→  │ │ │   │  │  • Scholar           │  │   │                    │
│ │ │Observe     │ │ │   │  └──────────────────────┘  │   │                    │
│ │ └────────────┘ │ │   │                            │   │                    │
│ └────────────────┘ │   │                            │   │                    │
└────────────────────┘   └────────────────────────────┘   └────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   FINAL ANSWER                                       │
│              "机智流是一个AI技术社区，专注于分享前沿学术热点..."                          │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、从提问到结果的完整流程

基于测试日志 `20260115_194046_output.log`，以下是真实执行流程：

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 1: 初始化                                                                   │
│ ─────────────────────────────────────────────────────────────────────────────── │
│  1. 加载 System Prompt (工具定义 + 日期)                                          │
│  2. 初始化 Context Manager (ENABLE_CONTEXT_MANAGEMENT=true)                      │
│  3. 启动 Supervisor (ENABLE_REFLECTION=true)                                     │
│  4. 并行启动 3 个 Rollout (多路径探索)                                             │
└──────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 2: ReAct 循环 (Round 1-7)                                                  │
│ ─────────────────────────────────────────────────────────────────────────────── │
│                                                                                  │
│  Round 1:  Think → 分解问题"机智流是什么"                                          │
│            Act   → search(["机智流 含义 定义 网络用语", ...])                       │
│            Observe → 获得搜索结果 (萌娘百科、知乎等)                                 │
│            Memory → 生成 Memory Unit 1 (sub_goal="搜索含义")                       │
│                                                                                  │
│  Round 2:  Think → 分析结果，发现无直接定义                                         │
│            Act   → search(["机智流 网络用语 意思", ...])                            │
│            Observe → 发现知乎账号 SmartFlowAI                                      │
│            Memory → 更新 Memory Unit (rounds_index=[1,2])                         │
│                                                                                  │
│  Round 3-4: Think → 发现多重含义(游戏术语/小说流派/技术社区)                          │
│             Act   → search + visit(知乎页面)                                      │
│             Observe → 知乎需要CAPTCHA验证，访问失败                                  │
│             Supervisor → 检测到tool_call格式错误，触发纠正                           │
│                                                                                  │
│  Round 5-6: Think → 尝试其他信息源                                                 │
│             Act   → visit(掘金博客) + search(公众号信息)                            │
│             Observe → 发现"机智流"公众号，获得关键信息                               │
│             Memory → 折叠历史轮次为压缩摘要                                         │
│                                                                                  │
│  Round 7:  Think → 信息足够，准备综合答案                                           │
│            Act   → 生成 <answer>...</answer>                                     │
└──────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 3: 答案生成与持久化                                                         │
│ ─────────────────────────────────────────────────────────────────────────────── │
│  1. 解析 <answer> 标签内容                                                        │
│  2. 保存 traces, messages, prediction 到 output.json                             │
│  3. 记录 browser_traces.jsonl (如有浏览器交互)                                     │
│  4. 标记 termination="answer"                                                    │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心模块功能详解

### 1. Main Agent (`agent.py`)

| 功能 | 描述 |
|------|------|
| ReAct 循环 | Think → Act → Observe 迭代直到找到答案 |
| 工具调用 | 解析 `<tool_call>` 标签，分发到对应工具 |
| Token 计数 | 使用 tokenizer 监控上下文长度，防止溢出 |
| 超时控制 | 90分钟整体超时 + 75次 LLM 调用限制 |

### 2. Context Manager (`context/tools.py`)

| 功能 | 描述 |
|------|------|
| Sub-goal 分割 | 将长任务按子目标切分为 Memory Unit |
| 记忆折叠 | 完成的子目标压缩为摘要，保留全局规划意识 |
| 细粒度追踪 | 当前子目标保持详细的 ReAct 轨迹 |
| 合并决策 | LLM 判断新轮次是否与当前子目标相关 |

### 3. Supervisor (`supervisor.py`)

| 场景 | 处理方式 |
|------|----------|
| 响应截断 | 添加纠正提示，要求简洁回复 |
| 缺少动作 | 提示模型输出 tool_call 或 answer |
| 接近限制 | 强制生成最终答案 |
| 工具解析失败 | 调用 LLM 纠正格式错误 |

### 4. Atomic Capability Pool

| 工具 | 实现 | 功能 |
|------|------|------|
| `search` | Serper API | Google 搜索，支持中英文 |
| `google_scholar` | Serper API | 学术论文检索 |
| `visit` | Jina + BrowserUse MCP | 网页内容抓取 + LLM 摘要 |
| `CodeExecutor` | SandboxFusion | Python 代码沙箱执行 |

---

## 四、框架核心优势

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              YUNQUE DEEPRESEARCH 优势                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  1. 自适应记忆管理                                                                │
│     ┌─────────────────────────────────────────────────────────────────────────┐ │
│     │  传统 Agent:  [全部历史] ───────────────────────────────► 上下文爆炸      │ │
│     │  Yunque:      [压缩摘要] + [当前细节] ────────────────► 有限上下文内完成   │ │
│     └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  2. 多路并行探索 (Rollout)                                                       │
│     同一问题启动 3 条独立路径，增加找到最优解的概率                                   │
│                                                                                 │
│  3. 主动异常监督                                                                  │
│     Supervisor 实时检测：格式错误 → 自动纠正，而非直接失败                           │
│                                                                                 │
│  4. 混合工具调度                                                                  │
│     简单任务 → 直接工具 (低延迟)                                                   │
│     复杂任务 → 专业 Sub-Agent (高质量)                                            │
│                                                                                 │
│  5. 模块化可扩展                                                                  │
│     统一接口：BaseTool → 轻松添加新工具或 Sub-Agent                                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、适用场景推荐 (20+)

考虑到测试显示 **Agent 速度较慢**（单问题需要多轮搜索和处理），以下场景强调 **质量重于速度**、**用户可接受异步结果**：

### A. 深度研究类 (核心场景)

| # | 场景 | 为何适合 |
|---|------|----------|
| 1 | **竞品深度分析报告** | 用户提交后等待数小时，期望详尽多源报告 |
| 2 | **学术文献综述生成** | 使用 google_scholar 跨库检索，综合多篇论文 |
| 3 | **行业趋势调研** | 搜索 + 网页阅读 + 数据分析，生成洞察报告 |
| 4 | **专利侵权分析** | 需要精确检索和深度比对，容忍长时间运行 |
| 5 | **投资尽职调查 (DD)** | 多维度信息收集，质量远重于速度 |

### B. 知识问答类 (复杂问题)

| # | 场景 | 为何适合 |
|---|------|----------|
| 6 | **法规合规咨询** | 需要查阅多个法规文档，综合解读 |
| 7 | **医学文献问答** | 严谨度要求高，多源交叉验证 |
| 8 | **技术选型建议** | 对比多个方案的官方文档和社区评价 |
| 9 | **历史事件考证** | 需要多源交叉验证，纠错机制重要 |
| 10 | **复杂数学/编程题解答** | Code 工具验证，多轮推理 |

### C. 数据处理类

| # | 场景 | 为何适合 |
|---|------|----------|
| 11 | **批量 PDF 报告解析** | DeepAnalyzer 处理文件，提取结构化信息 |
| 12 | **多表格交叉分析** | 上传多个 CSV/XLSX，生成汇总报告 |
| 13 | **网站内容批量抓取** | BrowserUse Agent 处理动态页面 |
| 14 | **多语言内容翻译+摘要** | 处理多语言源，生成统一报告 |

### D. 创作辅助类 (异步交付)

| # | 场景 | 为何适合 |
|---|------|----------|
| 15 | **深度技术博客生成** | 自动搜索、整理资料、生成长文 |
| 16 | **白皮书/报告起草** | 需要大量背景研究的正式文档 |
| 17 | **教程/课程大纲设计** | 基于领域知识结构化输出 |
| 18 | **案例库自动构建** | 批量搜索+整理成结构化案例集 |

### E. 自动化工作流 (后台任务)

| # | 场景 | 为何适合 |
|---|------|----------|
| 19 | **舆情监控报告** | 定时任务，批量搜索+摘要，用户次日查看 |
| 20 | **竞争对手动态追踪** | 每日/每周自动运行，生成变化报告 |
| 21 | **招聘候选人背调** | 多渠道信息收集，生成综合画像 |
| 22 | **供应商资质审核** | 自动检索工商信息、资质证书等 |
| 23 | **论文查重预检** | 学术检索+相似度分析 |

### F. 教育/考试场景

| # | 场景 | 为何适合 |
|---|------|----------|
| 24 | **GAIA/GPQA 等 Benchmark 评测** | 当前项目核心用途 |
| 25 | **复杂开放题自动评分** | 需要搜索验证答案正确性 |
| 26 | **学生研究项目辅导** | 引导式多轮探索，记录思考轨迹 |

---

## 六、不适用场景

| 场景 | 原因 |
|------|------|
| 实时对话机器人 | 延迟过高（每轮数秒到数十秒） |
| 简单事实查询 | 大材小用，直接 LLM 更快 |
| 高并发在线服务 | 单任务资源占用大 |
| 需要即时反馈的交互 | 用户等不及多轮搜索 |

---

## 七、推荐展示案例

基于框架特性，最能展示价值的 **Demo 场景**：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TOP 3 展示案例推荐                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  1. 「一键生成竞品分析报告」                                                       │
│     输入：公司名称 + 竞品列表                                                      │
│     输出：10页详细报告 (产品对比/市场数据/技术栈/融资历程)                            │
│     亮点：展示多工具协作 + 记忆管理 + 长报告生成                                     │
│                                                                                 │
│  2. 「学术论文研究助手」                                                           │
│     输入：研究问题 (如 "LLM 在医疗领域的最新应用")                                   │
│     输出：文献综述 + 关键论文摘要 + 研究方向建议                                     │
│     亮点：展示 google_scholar + PDF 解析 + 综合分析                                │
│                                                                                 │
│  3. 「复杂问题推理 (GAIA Benchmark)」                                              │
│     输入：需要多步推理+工具使用的难题                                               │
│     输出：完整推理链条 + 工具调用记录 + 最终答案                                     │
│     亮点：展示 ReAct 循环 + Supervisor 纠错 + 可解释性                              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、技术细节速查

### 关键配置项 (.env)

| 配置 | 说明 | 默认值 |
|------|------|--------|
| `LLM_MODEL` | 主 Agent 使用的模型 | gemini-3-pro |
| `ROLLOUT_COUNT` | 并行探索路径数 | 3 |
| `MAX_LLM_CALL_PER_RUN` | 单任务最大 LLM 调用次数 | 75 |
| `ENABLE_CONTEXT_MANAGEMENT` | 是否启用记忆管理 | true |
| `ENABLE_REFLECTION` | 是否启用 Supervisor 反思 | true |
| `ENABLE_BROWSER_AGENT` | 是否启用 BrowserUse | true |

### 关键文件

| 文件 | 功能 |
|------|------|
| `inference/agent.py` | 主 Agent ReAct 循环 |
| `inference/supervisor.py` | 异常检测与纠正 |
| `inference/context/tools.py` | 记忆管理 |
| `inference/tool_search.py` | 搜索工具 |
| `inference/tool_visit.py` | 网页访问工具 |
| `inference/prompt.py` | System Prompt 定义 |
